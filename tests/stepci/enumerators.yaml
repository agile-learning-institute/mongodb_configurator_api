version: "1.1"
name: Test Enumerators Endpoints
env:
  host: localhost:8081

tests:
  enumerators:
    name: Test Enumerators Endpoints
    steps:
      # Create new test enumeration files (different from existing ones)
      - name: Create Test Enumerations A
        http:
          url: http://${{env.host}}/api/enumerators/test_enum_a.yaml/
          method: PUT
          headers:
            Content-Type: application/json
          body: |
            {
              "file_name": "test_enum_a.yaml",
              "_locked": false,
              "version": 1,
              "enumerators": [
                {
                  "name": "test_status",
                  "values": [
                    {"value": "pending", "description": "Awaiting Processing"},
                    {"value": "completed", "description": "Processing Complete"}
                  ]
                }
              ]
            }
          check:
            status: /200/
            jsonpath:
              file_name: test_enum_a.yaml
              _locked: false
              version: 1
              enumerators[0].name: test_status
              enumerators[0].values[0].value: pending
              enumerators[0].values[0].description: Awaiting Processing

      - name: Create Test Enumerations B
        http:
          url: http://${{env.host}}/api/enumerators/test_enum_b.yaml/
          method: PUT
          headers:
            Content-Type: application/json
          body: |
            {
              "file_name": "test_enum_b.yaml",
              "_locked": false,
              "version": 2,
              "enumerators": [
                {
                  "name": "priority_level",
                  "values": [
                    {"value": "low", "description": "Low Priority"},
                    {"value": "medium", "description": "Medium Priority"},
                    {"value": "high", "description": "High Priority"}
                  ]
                }
              ]
            }
          check:
            status: /200/
            jsonpath:
              file_name: test_enum_b.yaml
              _locked: false
              version: 2
              enumerators[0].name: priority_level
              enumerators[0].values[0].value: low
              enumerators[0].values[0].description: Low Priority

      # Test lock all enumerators endpoint
      - name: Lock All Enumerators
        http:
          url: http://${{env.host}}/api/enumerators/
          method: PATCH
          headers:
            Content-Type: application/json
          check:
            status: /200/
            jsonpath:
              status: SUCCESS

      # Verify test files are locked by checking individual files
      - name: Verify Test Enum A is Locked
        http:
          url: http://${{env.host}}/api/enumerators/test_enum_a.yaml/
          method: GET
          check:
            status: /200/
            jsonpath:
              file_name: test_enum_a.yaml
              _locked: true
              version: 1
              enumerators[0].name: test_status
              enumerators[0].values[0].value: pending
              enumerators[0].values[0].description: Awaiting Processing

      - name: Verify Test Enum B is Locked
        http:
          url: http://${{env.host}}/api/enumerators/test_enum_b.yaml/
          method: GET
          check:
            status: /200/
            jsonpath:
              file_name: test_enum_b.yaml
              _locked: true
              version: 2
              enumerators[0].name: priority_level
              enumerators[0].values[0].value: low
              enumerators[0].values[0].description: Low Priority

      # Unlock test files individually
      - name: Unlock Test Enum A
        http:
          url: http://${{env.host}}/api/enumerators/test_enum_a.yaml/
          method: PUT
          headers:
            Content-Type: application/json
          body: |
            {
              "file_name": "test_enum_a.yaml",
              "_locked": false,
              "version": 1,
              "enumerators": [
                {
                  "name": "test_status",
                  "values": [
                    {"value": "pending", "description": "Awaiting Processing"},
                    {"value": "completed", "description": "Processing Complete"}
                  ]
                }
              ]
            }
          check:
            status: /200/
            jsonpath:
              file_name: test_enum_a.yaml
              _locked: false
              version: 1
              enumerators[0].name: test_status
              enumerators[0].values[0].value: pending
              enumerators[0].values[0].description: Awaiting Processing

      - name: Unlock Test Enum B
        http:
          url: http://${{env.host}}/api/enumerators/test_enum_b.yaml/
          method: PUT
          headers:
            Content-Type: application/json
          body: |
            {
              "file_name": "test_enum_b.yaml",
              "_locked": false,
              "version": 2,
              "enumerators": [
                {
                  "name": "priority_level",
                  "values": [
                    {"value": "low", "description": "Low Priority"},
                    {"value": "medium", "description": "Medium Priority"},
                    {"value": "high", "description": "High Priority"}
                  ]
                }
              ]
            }
          check:
            status: /200/
            jsonpath:
              file_name: test_enum_b.yaml
              _locked: false
              version: 2
              enumerators[0].name: priority_level
              enumerators[0].values[0].value: low
              enumerators[0].values[0].description: Low Priority

      # Verify test files are unlocked by checking individual files
      - name: Verify Test Enum A is Unlocked
        http:
          url: http://${{env.host}}/api/enumerators/test_enum_a.yaml/
          method: GET
          check:
            status: /200/
            jsonpath:
              file_name: test_enum_a.yaml
              _locked: false
              version: 1
              enumerators[0].name: test_status
              enumerators[0].values[0].value: pending
              enumerators[0].values[0].description: Awaiting Processing

      - name: Verify Test Enum B is Unlocked
        http:
          url: http://${{env.host}}/api/enumerators/test_enum_b.yaml/
          method: GET
          check:
            status: /200/
            jsonpath:
              file_name: test_enum_b.yaml
              _locked: false
              version: 2
              enumerators[0].name: priority_level
              enumerators[0].values[0].value: low
              enumerators[0].values[0].description: Low Priority

      # Delete the created test files (cleanup at the end)
      - name: Delete Test Enum A
        http:
          url: http://${{env.host}}/api/enumerators/test_enum_a.yaml/
          method: DELETE
          check:
            status: /200/
            jsonpath:
              status: SUCCESS

      - name: Delete Test Enum B
        http:
          url: http://${{env.host}}/api/enumerators/test_enum_b.yaml/
          method: DELETE
          check:
            status: /200/
            jsonpath:
              status: SUCCESS